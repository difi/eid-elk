#!/bin/bash

mkdir -p filebeat_application_logs/data
mkdir -p filebeat_access_logs/data
mkdir -p logstash/dead_letter_queue

docker-compose up -d elasticsearch kibana

sleep 30

# X-pack
curl -X POST -u elastic:changeme "localhost:9200/_xpack/license/start_trial?acknowledge=true"
curl -X PUT -u elastic:changeme "localhost:9200/_xpack/security/user/logstash_system/_password" -H 'Content-Type: application/json' -d'
{
  "password": "changeme"
}
'

# Add mapping templates
curl -X PUT -u elastic:changeme "localhost:9200/_template/application_template" -H 'Content-Type: application/json' -d @elasticsearch/application_template.json
curl -X PUT -u elastic:changeme "localhost:9200/_template/access_template" -H 'Content-Type: application/json' -d @elasticsearch/access_template.json

# Add Kibana index pattern, dashboard
curl -X POST -u elastic:changeme "localhost:5601/api/saved_objects/_bulk_create" -H 'kbn-xsrf: true' -H 'Content-Type: application/json' -d @kibana/saved_objects/export.json > /dev/null

docker-compose stop elasticsearch kibana
